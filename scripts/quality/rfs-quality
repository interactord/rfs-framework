#!/usr/bin/env python3
"""
RFS Quality Management CLI
í†µí•© í’ˆì§ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ CLI ì¸í„°í˜ì´ìŠ¤
"""

import argparse
import sys
from pathlib import Path
import json
from datetime import datetime

# ëª¨ë“ˆ ê²½ë¡œ ì¶”ê°€
sys.path.insert(0, str(Path(__file__).parent / "unified"))

from backup_manager import BackupManager
from safe_transformer import SafeTransformer
from quality_engine import QualityEngine


def cmd_check(args):
    """í’ˆì§ˆ ê²€ì‚¬ ëª…ë ¹"""
    engine = QualityEngine()
    
    # ëŒ€ìƒ ë””ë ‰í† ë¦¬
    target = Path(args.target) if args.target else Path("src/rfs")
    
    # ìë™ ë°±ì—…
    if args.auto_backup:
        print("ğŸ“¦ ìë™ ë°±ì—… í™œì„±í™”")
        engine.backup_manager.create_session("í’ˆì§ˆ ê²€ì‚¬ ë°±ì—…")
    
    # ê²€ì‚¬ ì‹¤í–‰
    results = engine.check_all(target)
    
    # ê²°ê³¼ ì¶œë ¥
    if args.format == "json":
        print(json.dumps(results, indent=2, ensure_ascii=False))
    
    return 0 if results["summary"]["failed"] == 0 else 1


def cmd_fix(args):
    """ì½”ë“œ ìë™ ìˆ˜ì • ëª…ë ¹"""
    engine = QualityEngine()
    
    # ëŒ€ìƒ ë””ë ‰í† ë¦¬
    target = Path(args.target) if args.target else Path("src/rfs")
    
    # Dry run ëª¨ë“œ
    if args.dry_run:
        print("ğŸ” Dry run ëª¨ë“œ - ì‹¤ì œ ë³€ê²½í•˜ì§€ ì•ŠìŒ")
        engine.transformer.dry_run = True
    
    # Safe ëª¨ë“œ
    if args.safe:
        print("ğŸ›¡ï¸ Safe ëª¨ë“œ - ìë™ ë°±ì—… ë° ê²€ì¦")
        engine.transformer.rollback_on_error = True
    
    # ë³€í™˜ ìœ í˜•
    transformation_type = args.type or "all"
    
    if transformation_type == "all":
        # ëª¨ë“  ë³€í™˜ ìˆœì°¨ ì‹¤í–‰
        transformations = ["syntax_fix", "isort", "black", "functional", "match_case"]
        for trans in transformations:
            print(f"\nğŸ”§ {trans} ì ìš© ì¤‘...")
            success = engine.transform_all(trans, target)
            if not success and args.safe:
                print("âŒ ë³€í™˜ ì‹¤íŒ¨ - ì¤‘ë‹¨")
                return 1
    else:
        # íŠ¹ì • ë³€í™˜ë§Œ ì‹¤í–‰
        success = engine.transform_all(transformation_type, target)
        if not success:
            return 1
    
    return 0


def cmd_backup(args):
    """ë°±ì—… ê´€ë¦¬ ëª…ë ¹"""
    manager = BackupManager()
    
    if args.action == "create":
        # ë°±ì—… ìƒì„±
        description = args.description or "ìˆ˜ë™ ë°±ì—…"
        session = manager.create_session(description)
        print(f"âœ… ë°±ì—… ì„¸ì…˜ ìƒì„±: {session.name}")
        
    elif args.action == "list":
        # ë°±ì—… ëª©ë¡
        sessions = manager.list_sessions()
        print(f"\nğŸ“‹ ë°±ì—… ì„¸ì…˜ ëª©ë¡ ({len(sessions)}ê°œ):")
        for session in sessions:
            status_icon = "ğŸŸ¢" if session["status"] == "active" else "âšª"
            print(f"{status_icon} {session['name']} - {session['description']} ({session['files_count']}ê°œ íŒŒì¼)")
            
    elif args.action == "rollback":
        # ë¡¤ë°±
        if args.session:
            # íŠ¹ì • ì„¸ì…˜ìœ¼ë¡œ ë¡¤ë°±
            session_path = manager.sessions_dir / args.session
            if session_path.exists():
                manager.current_session = session_path
                rolled_back = manager.rollback_session()
                print(f"âœ… {rolled_back}ê°œ íŒŒì¼ ë¡¤ë°± ì™„ë£Œ")
            else:
                print(f"âŒ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {args.session}")
                return 1
        else:
            # í˜„ì¬ ì„¸ì…˜ ë¡¤ë°±
            if manager.current_session:
                rolled_back = manager.rollback_session()
                print(f"âœ… {rolled_back}ê°œ íŒŒì¼ ë¡¤ë°± ì™„ë£Œ")
            else:
                print("âŒ í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤")
                return 1
                
    elif args.action == "clear":
        # ë°±ì—… ì •ë¦¬
        if args.all:
            manager.clear_all_backups(confirm=True)
        elif args.old:
            removed = manager.clear_old_backups()
            print(f"âœ… {removed}ê°œ ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ")
        else:
            print("--all ë˜ëŠ” --old ì˜µì…˜ì„ ì§€ì •í•˜ì„¸ìš”")
            return 1
            
    elif args.action == "status":
        # í˜„ì¬ ì„¸ì…˜ ìƒíƒœ
        info = manager.get_session_info()
        if info:
            print(f"\nğŸ“Š í˜„ì¬ ì„¸ì…˜ ì •ë³´:")
            print(f"  ê²½ë¡œ: {info['path']}")
            print(f"  ì‹œê°„: {info['timestamp']}")
            print(f"  ìƒíƒœ: {info['status']}")
            print(f"  íŒŒì¼: {info['files']}ê°œ")
            print(f"  í¬ê¸°: {info['size_mb']:.2f} MB")
        else:
            print("í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤")
    
    return 0


def cmd_session(args):
    """ì„¸ì…˜ ê´€ë¦¬ ëª…ë ¹"""
    manager = BackupManager()
    
    if args.action == "info":
        # ì„¸ì…˜ ì •ë³´
        info = manager.get_session_info()
        if info:
            print(json.dumps(info, indent=2, ensure_ascii=False))
        else:
            print("í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤")
            
    elif args.action == "metrics":
        # ì„¸ì…˜ ë©”íŠ¸ë¦­
        if manager.current_session:
            manifest = manager.load_manifest(manager.current_session)
            metrics = manifest.get("metrics", {})
            print(json.dumps(metrics, indent=2, ensure_ascii=False))
        else:
            print("í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤")
            
    elif args.action == "export":
        # ì„¸ì…˜ ë‚´ë³´ë‚´ê¸°
        if manager.current_session:
            export_path = Path(f"quality_session_{datetime.now().strftime('%Y%m%d_%H%M%S')}.tar.gz")
            archive_path = manager.archive_session(manager.current_session)
            shutil.move(archive_path, export_path)
            print(f"âœ… ì„¸ì…˜ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: {export_path}")
        else:
            print("í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤")
            return 1
    
    return 0


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    parser = argparse.ArgumentParser(
        description="RFS Framework í†µí•© í’ˆì§ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    subparsers = parser.add_subparsers(dest="command", help="ëª…ë ¹ì–´")
    
    # check ëª…ë ¹
    check_parser = subparsers.add_parser("check", help="í’ˆì§ˆ ê²€ì‚¬")
    check_parser.add_argument("target", nargs="?", help="ëŒ€ìƒ ë””ë ‰í† ë¦¬")
    check_parser.add_argument("--auto-backup", action="store_true", help="ìë™ ë°±ì—…")
    check_parser.add_argument("--format", choices=["text", "json"], default="text", help="ì¶œë ¥ í˜•ì‹")
    
    # fix ëª…ë ¹
    fix_parser = subparsers.add_parser("fix", help="ìë™ ìˆ˜ì •")
    fix_parser.add_argument("target", nargs="?", help="ëŒ€ìƒ ë””ë ‰í† ë¦¬")
    fix_parser.add_argument("--type", choices=["black", "isort", "functional", "match_case", "syntax_fix", "all"], help="ë³€í™˜ ìœ í˜•")
    fix_parser.add_argument("--safe", action="store_true", help="ì•ˆì „ ëª¨ë“œ")
    fix_parser.add_argument("--dry-run", action="store_true", help="ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ")
    
    # backup ëª…ë ¹
    backup_parser = subparsers.add_parser("backup", help="ë°±ì—… ê´€ë¦¬")
    backup_parser.add_argument("action", choices=["create", "list", "rollback", "clear", "status"], help="ì•¡ì…˜")
    backup_parser.add_argument("--session", help="ì„¸ì…˜ ì´ë¦„")
    backup_parser.add_argument("--description", help="ë°±ì—… ì„¤ëª…")
    backup_parser.add_argument("--all", action="store_true", help="ëª¨ë“  ë°±ì—…")
    backup_parser.add_argument("--old", action="store_true", help="ì˜¤ë˜ëœ ë°±ì—…")
    
    # session ëª…ë ¹
    session_parser = subparsers.add_parser("session", help="ì„¸ì…˜ ê´€ë¦¬")
    session_parser.add_argument("action", choices=["info", "metrics", "export"], help="ì•¡ì…˜")
    
    # ì¸ì íŒŒì‹±
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return 1
    
    # ëª…ë ¹ ì‹¤í–‰
    if args.command == "check":
        return cmd_check(args)
    elif args.command == "fix":
        return cmd_fix(args)
    elif args.command == "backup":
        return cmd_backup(args)
    elif args.command == "session":
        return cmd_session(args)
    else:
        parser.print_help()
        return 1


if __name__ == "__main__":
    sys.exit(main())